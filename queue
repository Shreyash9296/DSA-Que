import React, { useEffect, useMemo, useRef, useState } from 'react';
import { useRouter } from 'next/router';
import { Get } from '../services/ApiServices';
import Toast from '../components/Toast';
import {
  CheckCircle,
  Circle,
  Clock,
  FileEdit,
  Search,
  ChevronDown,
  Check,
  ChevronLeft,
  ChevronRight,
  X,
  BarChart3,
  Filter,
} from 'lucide-react';

export default function Queue() {
  // ============================================================================
  // JAVASCRIPT LOGIC - ALL BUSINESS LOGIC, STATE, FUNCTIONS AT TOP
  // ============================================================================
  
  const router = useRouter();

  // State Management
  const [mounted, setMounted] = useState(false);
  const [loading, setLoading] = useState(false);
  const [rows, setRows] = useState([]);
  const [error, setError] = useState(null);
  const [showToast, setShowToast] = useState(false);
  const [toastData, setToastData] = useState({ status: '', message: '' });
  const [region, setRegion] = useState('');
  const [isChecker, setIsChecker] = useState(false);
  const [view, setView] = useState('MAKER');
  const [filterStatus, setFilterStatus] = useState('ALL');
  const [filterType, setFilterType] = useState('ALL');
  const [filterName, setFilterName] = useState('');
  const [selectedPage, setSelectedPage] = useState(0);
  const [pageCount, setPageCount] = useState(0);
  const [focusedRowIndex, setFocusedRowIndex] = useState(-1);

  // Constants
  const perPage = 20;

  const typeOptionsNoAll = [
    { value: 'rule', label: 'Rule' },
    { value: 'fieldgroup', label: 'Field Group' },
    { value: 'entity', label: 'Entity' },
    { value: 'returncode', label: 'Return Code' },
    { value: 'valuelist', label: 'Value List' },
  ];

  const statusOptionsNoAll = [
    { value: 'APPROVED', label: 'Approved' },
    { value: 'REJECTED', label: 'Rejected' },
    { value: 'PENDING', label: 'Pending' },
    { value: 'DRAFT', label: 'Draft' },
  ];

  // Helper Functions
  const prettyType = (t) => {
    const m = {
      rule: 'Rule',
      fieldgroup: 'Field Group',
      entity: 'Entity',
      returncode: 'Return Code',
      valuelist: 'Value List',
    };
    return m[t?.toLowerCase?.()] || (t || '').toString();
  };

  // Computed Values
  const stats = useMemo(() => {
    const total = rows.length;
    const pending = rows.filter((r) => r.uiStatus === 'Pending').length;
    const approved = rows.filter((r) => r.uiStatus === 'Approved').length;
    const rejected = rows.filter((r) => r.uiStatus === 'Rejected').length;
    return { total, pending, approved, rejected };
  }, [rows]);

  const filteredRows = useMemo(() => {
    return rows.filter((r) => {
      const typePass =
        filterType === 'ALL' || (r.type && r.type.toLowerCase() === filterType.toLowerCase());
      const name = (r.name || '').toLowerCase();
      const namePass = !filterName || name.includes(filterName.trim().toLowerCase());

      if (view === 'CHECKER') return namePass && typePass;

      const statusPass =
        filterStatus === 'ALL' ||
        (filterStatus === 'APPROVED' && r.uiStatus === 'Approved') ||
        (filterStatus === 'REJECTED' && r.uiStatus === 'Rejected') ||
        (filterStatus === 'PENDING' && r.uiStatus === 'Pending') ||
        (filterStatus === 'DRAFT' && r.uiStatus === 'Draft');

      return statusPass && namePass && typePass;
    });
  }, [rows, filterType, filterName, filterStatus, view]);

  const startIndex = selectedPage * perPage;
  const pagedRows = filteredRows.slice(startIndex, startIndex + perPage);
  const typePlaceholderText = filterType === 'ALL' ? 'Select Data' : undefined;
  const statusPlaceholderText = filterStatus === 'ALL' ? 'Select Status' : undefined;
  const hasActiveFilters = filterStatus !== 'ALL' || filterType !== 'ALL' || filterName !== '';

  // Event Handlers
  const handlePrevPage = () => {
    if (selectedPage > 0) setSelectedPage(selectedPage - 1);
  };

  const handleNextPage = () => {
    if (selectedPage < pageCount - 1) setSelectedPage(selectedPage + 1);
  };

  const handlePageClick = (pageIndex) => {
    if (pageIndex !== selectedPage) setSelectedPage(pageIndex);
  };

  const clearFilters = () => {
    setFilterStatus('ALL');
    setFilterType('ALL');
    setFilterName('');
    setSelectedPage(0);
  };

  const handleRowKeyDown = (e, index) => {
    if (e.key === 'Enter') {
      handleAction(pagedRows[index]);
    } else if (e.key === 'ArrowDown') {
      e.preventDefault();
      const nextIndex = Math.min(index + 1, pagedRows.length - 1);
      setFocusedRowIndex(nextIndex);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      const prevIndex = Math.max(index - 1, 0);
      setFocusedRowIndex(prevIndex);
    }
  };

  const handleAction = async (row) => {
    try {
      const type = row.type;
      const refId = row.refId;
      const opStatus = row.operationStatus;

      if (!type || !refId) {
        setToastData({ status: 'error', message: 'Missing type/refId' });
        setShowToast(true);
        return;
      }

      sessionStorage.setItem('OpStatus', String(opStatus || '').toUpperCase());
      const isCheckerView = view === 'CHECKER';

      if (type === 'rule') {
        const response = await Get(`rule/${refId}`, { region }, { setShowToast, setToastData });
        const data = response?.data;

        if (isCheckerView) {
          sessionStorage.setItem('checkerRuleData', JSON.stringify(data));
          sessionStorage.setItem('checkerMode', 'true');
          router.push('/CreateRule');
        } else {
          sessionStorage.setItem('makerData', JSON.stringify(data));
          sessionStorage.removeItem('checkerRuleData');
          sessionStorage.removeItem('checkerMode');
          sessionStorage.removeItem('ruleData');
          sessionStorage.removeItem('importedRuleData');
          router.push('/CreateRule');
        }
        return;
      }

      if (type === 'fieldgroup') {
        const resp = await Get(`field-group/ID/${refId}`, {}, { setShowToast, setToastData });
        router.push({
          pathname: '/CreateGroup',
          query: { GroupData: JSON.stringify(resp?.data || {}), opStatus },
        });
        return;
      }

      if (type === 'entity') {
        const resp = await Get(`entity/ID/${refId}`, {}, { setShowToast, setToastData });
        router.push({
          pathname: '/CreateEntity',
          query: { EntityData: JSON.stringify(resp?.data || {}), opStatus },
        });
        return;
      }

      if (type === 'returncode') {
        const resp = await Get(`return-code/ID/${refId}`, { region }, { setShowToast, setToastData });
        router.push({
          pathname: '/CreateReturnCode',
          query: {
            returnCodeData: JSON.stringify(resp?.data || {}),
            opStatus,
            ...(isCheckerView ? { makerId: row.makerId } : {}),
          },
        });
        return;
      }

      if (type === 'valuelist') {
        const resp = await Get(`value-list/ID/${refId}`, {}, { setShowToast, setToastData });
        router.push({
          pathname: '/CreateValueList',
          query: { valueData: JSON.stringify(resp?.data || {}), opStatus },
        });
        return;
      }

      setToastData({ status: 'error', message: `Unsupported type: ${type}` });
      setShowToast(true);
    } catch (err) {
      console.log('handleAction error:', err);
      setToastData({ status: 'error', message: 'Failed to open item' });
      setShowToast(true);
    }
  };

  // Effects
  useEffect(() => setMounted(true), []);

  useEffect(() => {
    if (typeof window === 'undefined') return;
    const r = localStorage.getItem('region') || '';
    setRegion(r);
    const checkerLS = localStorage.getItem('isChecker') === 'true';
    setIsChecker(checkerLS);
    setView(checkerLS ? 'CHECKER' : 'MAKER');
  }, []);

  useEffect(() => {
    if (view === 'CHECKER' && !isChecker) setView('MAKER');
  }, [view, isChecker]);

  useEffect(() => {
    if (!mounted) return;
    if (typeof window === 'undefined') return;

    const load = async () => {
      setLoading(true);
      setError(null);

      try {
        if (view === 'MAKER') {
          const data = await Get('/data/user-data', { region }, { setShowToast, setToastData });
          const list = Array.isArray(data?.data) ? data.data : [];

          const normalized = list
            .map((item) => {
              const op = String(item.operationStatus || '').toUpperCase();
              let uiStatus = 'Draft';
              if (
                op === 'PENDING_FOR_APPROVAL' ||
                op === 'PENDING_WITH_APPROVER' ||
                op === 'PENDING'
              )
                uiStatus = 'Pending';
              else if (op === 'APPROVE' || op === 'APPROVED') uiStatus = 'Approved';
              else if (op === 'REJECTED') uiStatus = 'Rejected';
              else if (op === 'DRAFT') uiStatus = 'Draft';

              return {
                id: item.id,
                refId: item.refId,
                type: String(item.type || '').toLowerCase(),
                name: item.refName || '-',
                description: item.refDescription ?? '-',
                uiStatus,
                operationStatus: op,
                typeRaw: item.type,
                checkerId: item.checkerId,
                rejectedReason: item.rejectedReason || '',
                approveAt: item.approveAt,
                rejectedAt: item.rejectedAt,
                submittedAt: item.submittedAt,
                makerId: item.makerId,
              };
            })
            .sort((a, b) => {
              const aIsDraft = a.uiStatus === 'Draft' || !a.submittedAt;
              const bIsDraft = b.uiStatus === 'Draft' || !b.submittedAt;
              if (aIsDraft && !bIsDraft) return -1;
              if (!aIsDraft && bIsDraft) return 1;
              const ta = a.submittedAt ? new Date(a.submittedAt).getTime() : 0;
              const tb = b.submittedAt ? new Date(b.submittedAt).getTime() : 0;
              return tb - ta;
            });

          setRows(normalized);
          return;
        }

        if (!isChecker) {
          setRows([]);
          setError('You do not have checker access.');
          return;
        }

        const data = await Get('/data/pending-approval', { region }, { setShowToast, setToastData });
        const list = Array.isArray(data?.data) ? data.data : [];
        const username = localStorage.getItem('username');
        const filteredList = list.filter((item) => item.makerId !== username);

        const normalized = filteredList
          .map((item) => {
            const op = String(item.operationStatus || '').toUpperCase();
            let uiStatus = 'Draft';
            if (
              op === 'PENDING_FOR_APPROVAL' ||
              op === 'PENDING_WITH_APPROVER' ||
              op === 'PENDING'
            )
              uiStatus = 'Pending';
            else if (op === 'APPROVE' || op === 'APPROVED') uiStatus = 'Approved';
            else if (op === 'REJECTED') uiStatus = 'Rejected';
            else if (op === 'DRAFT') uiStatus = 'Draft';

            return {
              id: item.id,
              refId: item.refId,
              type: String(item.type || '').toLowerCase(),
              typeRaw: item.type,
              name: item.refName || '-',
              description: item.refDescription ?? '',
              uiStatus,
              operationStatus: op,
              makerId: item.makerId,
              checkerId: item.checkerId,
              rejectedReason: item.rejectedReason || '',
              approveAt: item.approveAt,
              rejectedAt: item.rejectedAt,
              submittedAt: item.submittedAt,
            };
          })
          .sort((a, b) => {
            const ta = a.submittedAt ? new Date(a.submittedAt).getTime() : 0;
            const tb = b.submittedAt ? new Date(b.submittedAt).getTime() : 0;
            return tb - ta;
          });

        setRows(normalized);
      } catch (e) {
        console.log('Queue load error:', e);
        setError('Failed to load queue data');
      } finally {
        setLoading(false);
      }
    };

    load();
  }, [mounted, view, region, isChecker]);

  useEffect(() => {
    setSelectedPage(0);
  }, [filterStatus, filterName, filterType, view]);

  useEffect(() => {
    const pages = Math.ceil(filteredRows.length / perPage);
    setPageCount(pages);
    setSelectedPage((prev) => (prev >= pages ? Math.max(pages - 1, 0) : prev));
  }, [filteredRows]);

  useEffect(() => {
    if (focusedRowIndex >= 0 && focusedRowIndex < pagedRows.length) {
      const rowElement = document.getElementById(`row-${focusedRowIndex}`);
      rowElement?.focus();
    }
  }, [focusedRowIndex, pagedRows.length]);

  // Sub-Components
  const StatusCell = ({ s }) => {
    const configs = {
      Approved: {
        icon: CheckCircle,
        label: 'Approved',
        className: 'bg-emerald-50 text-emerald-700 border border-emerald-200',
      },
      Pending: {
        icon: Clock,
        label: 'Pending',
        className: 'bg-blue-50 text-blue-700 border border-blue-200',
      },
      Rejected: {
        icon: Circle,
        label: 'Rejected',
        className: 'bg-red-50 text-red-700 border border-red-200',
      },
      Draft: {
        icon: FileEdit,
        label: 'Draft',
        className: 'bg-amber-50 text-amber-700 border border-amber-200',
      },
    };

    const config = configs[s] || configs.Draft;
    const Icon = config.icon;

    return (
      <span className={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium ${config.className}`}>
        <Icon className="w-3.5 h-3.5" />
        {config.label}
      </span>
    );
  };

  function SmallSelect({ value, onChange, options, placeholder = 'Select', ariaLabel, label }) {
    const [open, setOpen] = useState(false);
    const btnRef = useRef(null);
    const menuRef = useRef(null);
    const selected = options.find((o) => o.value === value);

    useEffect(() => {
      const onDocClick = (e) => {
        if (!btnRef.current || !menuRef.current) return;
        if (!btnRef.current.contains(e.target) && !menuRef.current.contains(e.target)) {
          setOpen(false);
        }
      };
      document.addEventListener('mousedown', onDocClick);
      return () => document.removeEventListener('mousedown', onDocClick);
    }, []);

    const handleKey = (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        setOpen((o) => !o);
      } else if (e.key === 'Escape') {
        setOpen(false);
      }
    };

    return (
      <div className="relative flex-1">
        {label && (
          <label className="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-2">
            {label}
          </label>
        )}
        <button
          ref={btnRef}
          type="button"
          aria-haspopup="listbox"
          aria-expanded={open}
          aria-label={ariaLabel}
          onClick={() => setOpen((o) => !o)}
          onKeyDown={handleKey}
          className={`inline-flex h-10 w-full items-center justify-between rounded-md border-[1.5px] bg-white px-4 text-sm font-medium transition-all ${
            open ? 'border-blue-500 ring-2 ring-blue-200' : 'border-gray-300 hover:border-gray-400'
          } focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200`}
        >
          <span className={selected ? 'text-gray-800' : 'text-gray-500'}>
            {selected ? selected.label : placeholder}
          </span>
          <ChevronDown className={`w-4 h-4 text-gray-500 transition-transform ${open ? 'rotate-180' : ''}`} />
        </button>

        {open && (
          <div
            ref={menuRef}
            role="listbox"
            className="absolute z-50 mt-2 w-full overflow-auto rounded-md border border-gray-200 bg-white shadow-lg animate-slideDown"
          >
            <ul className="py-1 max-h-72">
              {options.map((opt) => {
                const isSel = opt.value === value;
                return (
                  <li
                    key={opt.value}
                    role="option"
                    aria-selected={isSel}
                    onClick={() => {
                      onChange(opt.value);
                      setOpen(false);
                    }}
                    className={`relative flex cursor-pointer select-none items-center px-4 py-2.5 text-sm transition-colors ${
                      isSel ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-800 hover:bg-gray-50'
                    }`}
                  >
                    <span>{opt.label}</span>
                    {isSel && <Check className="absolute right-3 h-4 w-4 text-blue-600" />}
                  </li>
                );
              })}
            </ul>
          </div>
        )}
      </div>
    );
  }

  // Early Return
  if (!mounted) return null;

  // ============================================================================
  // JSX / TAILWIND CSS - ALL UI RENDERING BELOW
  // ============================================================================

  return (
    <div className="min-h-screen bg-gray-50">
      
      {/* Toast Notification */}
      {showToast && (
        <Toast
          status={toastData.status}
          message={toastData.message}
          onClose={() => setShowToast(false)}
        />
      )}

      {/* Main Container */}
      <div className="max-w-[1400px] mx-auto px-6 py-8">
        
        {/* Page Header Section */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-2">
            <h1 className="text-3xl font-bold text-gray-900">
              Queues
            </h1>
            
            {/* Maker/Checker Toggle */}
            <div className="flex items-center gap-2 bg-white border border-gray-300 rounded-lg p-1 shadow-sm">
              <button
                onClick={() => setView('MAKER')}
                className={`px-5 py-2 rounded-md text-sm font-medium transition-all ${
                  view === 'MAKER'
                    ? 'bg-[#DB0011] text-white shadow-sm'
                    : 'text-gray-700 hover:bg-gray-100'
                }`}
                aria-pressed={view === 'MAKER'}
              >
                Maker
              </button>
              <button
                onClick={() => setView('CHECKER')}
                disabled={!isChecker}
                className={`px-5 py-2 rounded-md text-sm font-medium transition-all ${
                  view === 'CHECKER'
                    ? 'bg-[#DB0011] text-white shadow-sm'
                    : 'text-gray-700 hover:bg-gray-100 disabled:opacity-40 disabled:cursor-not-allowed'
                }`}
                aria-pressed={view === 'CHECKER'}
              >
                Checker
              </button>
            </div>
          </div>
          
          <p className="text-sm text-gray-600">
            View and manage requests pending action and history
          </p>
        </div>

        {/* Statistics Cards Section */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
          
          {/* Total Requests Card */}
          <div className="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">
                  Total Requests
                </p>
                <p className="text-2xl font-bold text-gray-900">
                  {stats.total}
                </p>
              </div>
              <div className="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                <BarChart3 className="w-6 h-6 text-gray-600" />
          