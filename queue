import React, { useEffect, useMemo, useRef, useState } from 'react';
import { useRouter } from 'next/router';
import { Get } from '../services/ApiServices';
import Toast from '../components/Toast';
import {
  CheckCircle,
  Circle,
  Clock,
  FileEdit,
  Search,
  ChevronDown,
  Check,
  ChevronLeft,
  ChevronRight,
  X,
  BarChart3,
  Filter,
} from 'lucide-react';

export default function Queue() {
  // ============================================================================
  // JAVASCRIPT LOGIC - ALL BUSINESS LOGIC, STATE, FUNCTIONS AT TOP
  // ============================================================================
  
  const router = useRouter();

  // State Management
  const [mounted, setMounted] = useState(false);
  const [loading, setLoading] = useState(false);
  const [rows, setRows] = useState([]);
  const [error, setError] = useState(null);
  const [showToast, setShowToast] = useState(false);
  const [toastData, setToastData] = useState({ status: '', message: '' });
  const [region, setRegion] = useState('');
  const [isChecker, setIsChecker] = useState(false);
  const [view, setView] = useState('MAKER');
  const [filterStatus, setFilterStatus] = useState('ALL');
  const [filterType, setFilterType] = useState('ALL');
  const [filterName, setFilterName] = useState('');
  const [selectedPage, setSelectedPage] = useState(0);
  const [pageCount, setPageCount] = useState(0);
  const [focusedRowIndex, setFocusedRowIndex] = useState(-1);

  // Constants
  const perPage = 20;

  const typeOptionsNoAll = [
    { value: 'rule', label: 'Rule' },
    { value: 'fieldgroup', label: 'Field Group' },
    { value: 'entity', label: 'Entity' },
    { value: 'returncode', label: 'Return Code' },
    { value: 'valuelist', label: 'Value List' },
  ];

  const statusOptionsNoAll = [
    { value: 'APPROVED', label: 'Approved' },
    { value: 'REJECTED', label: 'Rejected' },
    { value: 'PENDING', label: 'Pending' },
    { value: 'DRAFT', label: 'Draft' },
  ];

  // Helper Functions
  const prettyType = (t) => {
    const m = {
      rule: 'Rule',
      fieldgroup: 'Field Group',
      entity: 'Entity',
      returncode: 'Return Code',
      valuelist: 'Value List',
    };
    return m[t?.toLowerCase?.()] || (t || '').toString();
  };

  // Computed Values
  const stats = useMemo(() => {
    const total = rows.length;
    const pending = rows.filter((r) => r.uiStatus === 'Pending').length;
    const approved = rows.filter((r) => r.uiStatus === 'Approved').length;
    const rejected = rows.filter((r) => r.uiStatus === 'Rejected').length;
    return { total, pending, approved, rejected };
  }, [rows]);

  const filteredRows = useMemo(() => {
    return rows.filter((r) => {
      const typePass =
        filterType === 'ALL' || (r.type && r.type.toLowerCase() === filterType.toLowerCase());
      const name = (r.name || '').toLowerCase();
      const namePass = !filterName || name.includes(filterName.trim().toLowerCase());

      if (view === 'CHECKER') return namePass && typePass;

      const statusPass =
        filterStatus === 'ALL' ||
        (filterStatus === 'APPROVED' && r.uiStatus === 'Approved') ||
        (filterStatus === 'REJECTED' && r.uiStatus === 'Rejected') ||
        (filterStatus === 'PENDING' && r.uiStatus === 'Pending') ||
        (filterStatus === 'DRAFT' && r.uiStatus === 'Draft');

      return statusPass && namePass && typePass;
    });
  }, [rows, filterType, filterName, filterStatus, view]);

  const startIndex = selectedPage * perPage;
  const pagedRows = filteredRows.slice(startIndex, startIndex + perPage);
  const typePlaceholderText = filterType === 'ALL' ? 'Select Data' : undefined;
  const statusPlaceholderText = filterStatus === 'ALL' ? 'Select Status' : undefined;
  const hasActiveFilters = filterStatus !== 'ALL' || filterType !== 'ALL' || filterName !== '';

  // Event Handlers
  const handlePrevPage = () => {
    if (selectedPage > 0) setSelectedPage(selectedPage - 1);
  };

  const handleNextPage = () => {
    if (selectedPage < pageCount - 1) setSelectedPage(selectedPage + 1);
  };

  const handlePageClick = (pageIndex) => {
    if (pageIndex !== selectedPage) setSelectedPage(pageIndex);
  };

  const clearFilters = () => {
    setFilterStatus('ALL');
    setFilterType('ALL');
    setFilterName('');
    setSelectedPage(0);
  };

  const handleRowKeyDown = (e, index) => {
    if (e.key === 'Enter') {
      handleAction(pagedRows[index]);
    } else if (e.key === 'ArrowDown') {
      e.preventDefault();
      const nextIndex = Math.min(index + 1, pagedRows.length - 1);
      setFocusedRowIndex(nextIndex);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      const prevIndex = Math.max(index - 1, 0);
      setFocusedRowIndex(prevIndex);
    }
  };

  const handleAction = async (row) => {
    try {
      const type = row.type;
      const refId = row.refId;
      const opStatus = row.operationStatus;

      if (!type || !refId) {
        setToastData({ status: 'error', message: 'Missing type/refId' });
        setShowToast(true);
        return;
      }

      sessionStorage.setItem('OpStatus', String(opStatus || '').toUpperCase());
      const isCheckerView = view === 'CHECKER';

      if (type === 'rule') {
        const response = await Get(`rule/${refId}`, { region }, { setShowToast, setToastData });
        const data = response?.data;

        if (isCheckerView) {
          sessionStorage.setItem('checkerRuleData', JSON.stringify(data));
          sessionStorage.setItem('checkerMode', 'true');
          router.push('/CreateRule');
        } else {
          sessionStorage.setItem('makerData', JSON.stringify(data));
          sessionStorage.removeItem('checkerRuleData');
          sessionStorage.removeItem('checkerMode');
          sessionStorage.removeItem('ruleData');
          sessionStorage.removeItem('importedRuleData');
          router.push('/CreateRule');
        }
        return;
      }

      if (type === 'fieldgroup') {
        const resp = await Get(`field-group/ID/${refId}`, {}, { setShowToast, setToastData });
        router.push({
          pathname: '/CreateGroup',
          query: { GroupData: JSON.stringify(resp?.data || {}), opStatus },
        });
        return;
      }

      if (type === 'entity') {
        const resp = await Get(`entity/ID/${refId}`, {}, { setShowToast, setToastData });
        router.push({
          pathname: '/CreateEntity',
          query: { EntityData: JSON.stringify(resp?.data || {}), opStatus },
        });
        return;
      }

      if (type === 'returncode') {
        const resp = await Get(`return-code/ID/${refId}`, { region }, { setShowToast, setToastData });
        router.push({
          pathname: '/CreateReturnCode',
          query: {
            returnCodeData: JSON.stringify(resp?.data || {}),
            opStatus,
            ...(isCheckerView ? { makerId: row.makerId } : {}),
          },
        });
        return;
      }

      if (type === 'valuelist') {
        const resp = await Get(`value-list/ID/${refId}`, {}, { setShowToast, setToastData });
        router.push({
          pathname: '/CreateValueList',
          query: { valueData: JSON.stringify(resp?.data || {}), opStatus },
        });
        return;
      }

      setToastData({ status: 'error', message: `Unsupported type: ${type}` });
      setShowToast(true);
    } catch (err) {
      console.log('handleAction error:', err);
      setToastData({ status: 'error', message: 'Failed to open item' });
      setShowToast(true);
    }
  };

  // Effects
  useEffect(() => setMounted(true), []);

  useEffect(() => {
    if (typeof window === 'undefined') return;
    const r = localStorage.getItem('region') || '';
    setRegion(r);
    const checkerLS = localStorage.getItem('isChecker') === 'true';
    setIsChecker(checkerLS);
    setView(checkerLS ? 'CHECKER' : 'MAKER');
  }, []);

  useEffect(() => {
    if (view === 'CHECKER' && !isChecker) setView('MAKER');
  }, [view, isChecker]);

  useEffect(() => {
    if (!mounted) return;
    if (typeof window === 'undefined') return;

    const load = async () => {
      setLoading(true);
      setError(null);

      try {
        if (view === 'MAKER') {
          const data = await Get('/data/user-data', { region }, { setShowToast, setToastData });
          const list = Array.isArray(data?.data) ? data.data : [];

          const normalized = list
            .map((item) => {
              const op = String(item.operationStatus || '').toUpperCase();
              let uiStatus = 'Draft';
              if (
                op === 'PENDING_FOR_APPROVAL' ||
                op === 'PENDING_WITH_APPROVER' ||
                op === 'PENDING'
              )
                uiStatus = 'Pending';
              else if (op === 'APPROVE' || op === 'APPROVED') uiStatus = 'Approved';
              else if (op === 'REJECTED') uiStatus = 'Rejected';
              else if (op === 'DRAFT') uiStatus = 'Draft';

              return {
                id: item.id,
                refId: item.refId,
                type: String(item.type || '').toLowerCase(),
                name: item.refName || '-',
                description: item.refDescription ?? '-',
                uiStatus,
                operationStatus: op,
                typeRaw: item.type,
                checkerId: item.checkerId,
                rejectedReason: item.rejectedReason || '',
                approveAt: item.approveAt,
                rejectedAt: item.rejectedAt,
                submittedAt: item.submittedAt,
                makerId: item.makerId,
              };
            })
            .sort((a, b) => {
              const aIsDraft = a.uiStatus === 'Draft' || !a.submittedAt;
              const bIsDraft = b.uiStatus === 'Draft' || !b.submittedAt;
              if (aIsDraft && !bIsDraft) return -1;
              if (!aIsDraft && bIsDraft) return 1;
              const ta = a.submittedAt ? new Date(a.submittedAt).getTime() : 0;
              const tb = b.submittedAt ? new Date(b.submittedAt).getTime() : 0;
              return tb - ta;
            });

          setRows(normalized);
          return;
        }

        if (!isChecker) {
          setRows([]);
          setError('You do not have checker access.');
          return;
        }

        const data = await Get('/data/pending-approval', { region }, { setShowToast, setToastData });
        const list = Array.isArray(data?.data) ? data.data : [];
        const username = localStorage.getItem('username');
        const filteredList = list.filter((item) => item.makerId !== username);

        const normalized = filteredList
          .map((item) => {
            const op = String(item.operationStatus || '').toUpperCase();
            let uiStatus = 'Draft';
            if (
              op === 'PENDING_FOR_APPROVAL' ||
              op === 'PENDING_WITH_APPROVER' ||
              op === 'PENDING'
            )
              uiStatus = 'Pending';
            else if (op === 'APPROVE' || op === 'APPROVED') uiStatus = 'Approved';
            else if (op === 'REJECTED') uiStatus = 'Rejected';
            else if (op === 'DRAFT') uiStatus = 'Draft';

            return {
              id: item.id,
              refId: item.refId,
              type: String(item.type || '').toLowerCase(),
              typeRaw: item.type,
              name: item.refName || '-',
              description: item.refDescription ?? '',
              uiStatus,
              operationStatus: op,
              makerId: item.makerId,
              checkerId: item.checkerId,
              rejectedReason: item.rejectedReason || '',
              approveAt: item.approveAt,
              rejectedAt: item.rejectedAt,
              submittedAt: item.submittedAt,
            };
          })
          .sort((a, b) => {
            const ta = a.submittedAt ? new Date(a.submittedAt).getTime() : 0;
            const tb = b.submittedAt ? new Date(b.submittedAt).getTime() : 0;
            return tb - ta;
          });

        setRows(normalized);
      } catch (e) {
        console.log('Queue load error:', e);
        setError('Failed to load queue data');
      } finally {
        setLoading(false);
      }
    };

    load();
  }, [mounted, view, region, isChecker]);

  useEffect(() => {
    setSelectedPage(0);
  }, [filterStatus, filterName, filterType, view]);

  useEffect(() => {
    const pages = Math.ceil(filteredRows.length / perPage);
    setPageCount(pages);
    setSelectedPage((prev) => (prev >= pages ? Math.max(pages - 1, 0) : prev));
  }, [filteredRows]);

  useEffect(() => {
    if (focusedRowIndex >= 0 && focusedRowIndex < pagedRows.length) {
      const rowElement = document.getElementById(`row-${focusedRowIndex}`);
      rowElement?.focus();
    }
  }, [focusedRowIndex, pagedRows.length]);

  // Sub-Components
  const StatusCell = ({ s }) => {
    const configs = {
      Approved: {
        icon: CheckCircle,
        label: 'Approved',
        className: 'bg-emerald-50 text-emerald-700 border border-emerald-200',
      },
      Pending: {
        icon: Clock,
        label: 'Pending',
        className: 'bg-blue-50 text-blue-700 border border-blue-200',
      },
      Rejected: {
        icon: Circle,
        label: 'Rejected',
        className: 'bg-red-50 text-red-700 border border-red-200',
      },
      Draft: {
        icon: FileEdit,
        label: 'Draft',
        className: 'bg-amber-50 text-amber-700 border border-amber-200',
      },
    };

    const config = configs[s] || configs.Draft;
    const Icon = config.icon;

    return (
      <span className={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium ${config.className}`}>
        <Icon className="w-3.5 h-3.5" />
        {config.label}
      </span>
    );
  };

  function SmallSelect({ value, onChange, options, placeholder = 'Select', ariaLabel, label }) {
    const [open, setOpen] = useState(false);
    const btnRef = useRef(null);
    const menuRef = useRef(null);
    const selected = options.find((o) => o.value === value);

    useEffect(() => {
      const onDocClick = (e) => {
        if (!btnRef.current || !menuRef.current) return;
        if (!btnRef.current.contains(e.target) && !menuRef.current.contains(e.target)) {
          setOpen(false);
        }
      };
      document.addEventListener('mousedown', onDocClick);
      return () => document.removeEventListener('mousedown', onDocClick);
    }, []);

    const handleKey = (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        setOpen((o) => !o);
      } else if (e.key === 'Escape') {
        setOpen(false);
      }
    };

    return (
      <div className="relative flex-1">
        {label && (
          <label className="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-2">
            {label}
          </label>
        )}
        <button
          ref={btnRef}
          type="button"
          aria-haspopup="listbox"
          aria-expanded={open}
          aria-label={ariaLabel}
          onClick={() => setOpen((o) => !o)}
          onKeyDown={handleKey}
          className={`inline-flex h-10 w-full items-center justify-between rounded-md border-[1.5px] bg-white px-4 text-sm font-medium transition-all ${
            open ? 'border-blue-500 ring-2 ring-blue-200' : 'border-gray-300 hover:border-gray-400'
          } focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200`}
        >
          <span className={selected ? 'text-gray-800' : 'text-gray-500'}>
            {selected ? selected.label : placeholder}
          </span>
          <ChevronDown className={`w-4 h-4 text-gray-500 transition-transform ${open ? 'rotate-180' : ''}`} />
        </button>

        {open && (
          <div
            ref={menuRef}
            role="listbox"
            className="absolute z-50 mt-2 w-full overflow-auto rounded-md border border-gray-200 bg-white shadow-lg animate-slideDown"
          >
            <ul className="py-1 max-h-72">
              {options.map((opt) => {
                const isSel = opt.value === value;
                return (
                  <li
                    key={opt.value}
                    role="option"
                    aria-selected={isSel}
                    onClick={() => {
                      onChange(opt.value);
                      setOpen(false);
                    }}
                    className={`relative flex cursor-pointer select-none items-center px-4 py-2.5 text-sm transition-colors ${
                      isSel ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-800 hover:bg-gray-50'
                    }`}
                  >
                    <span>{opt.label}</span>
                    {isSel && <Check className="absolute right-3 h-4 w-4 text-blue-600" />}
                  </li>
                );
              })}
            </ul>
          </div>
        )}
      </div>
    );
  }

  // Early Return
  if (!mounted) return null;

  // ============================================================================
  // JSX / TAILWIND CSS - ALL UI RENDERING BELOW
  // ============================================================================

  return (
    <div className="min-h-screen bg-gray-50">
      
      {/* Toast Notification */}
      {showToast && (
        <Toast
          status={toastData.status}
          message={toastData.message}
          onClose={() => setShowToast(false)}
        />
      )}

      {/* Main Container */}
      <div className="max-w-[1400px] mx-auto px-6 py-8">
        
        {/* Page Header Section */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-2">
            <h1 className="text-3xl font-bold text-gray-900">
              Queues
            </h1>
            
            {/* Maker/Checker Toggle */}
            <div className="flex items-center gap-2 bg-white border border-gray-300 rounded-lg p-1 shadow-sm">
              <button
                onClick={() => setView('MAKER')}
                className={`px-5 py-2 rounded-md text-sm font-medium transition-all ${
                  view === 'MAKER'
                    ? 'bg-[#DB0011] text-white shadow-sm'
                    : 'text-gray-700 hover:bg-gray-100'
                }`}
                aria-pressed={view === 'MAKER'}
              >
                Maker
              </button>
              <button
                onClick={() => setView('CHECKER')}
                disabled={!isChecker}
                className={`px-5 py-2 rounded-md text-sm font-medium transition-all ${
                  view === 'CHECKER'
                    ? 'bg-[#DB0011] text-white shadow-sm'
                    : 'text-gray-700 hover:bg-gray-100 disabled:opacity-40 disabled:cursor-not-allowed'
                }`}
                aria-pressed={view === 'CHECKER'}
              >
                Checker
              </button>
            </div>
          </div>
          
          <p className="text-sm text-gray-600">
            View and manage requests pending action and history
          </p>
        </div>

        {/* Statistics Cards Section */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
          
          {/* Total Requests Card */}
          <div className="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">
                  Total Requests
                </p>
                <p className="text-2xl font-bold text-gray-900">
                  {stats.total}
                </p>
              </div>
              <div className="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                <BarChart3 className="w-6 h-6 text-gray-600" />
              </div>
            </div>
          </div>

          {/* Pending Card */}
          <div className="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">
                  Pending
                </p>
                <p className="text-2xl font-bold text-blue-700">
                  {stats.pending}
                </p>
              </div>
              <div className="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center">
                <Clock className="w-6 h-6 text-blue-600" />
              </div>
            </div>
          </div>

          {/* Approved Card */}
          <div className="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">
                  Approved
                </p>
                <p className="text-2xl font-bold text-emerald-700">
                  {stats.approved}
                </p>
              </div>
              <div className="w-12 h-12 bg-emerald-50 rounded-lg flex items-center justify-center">
                <CheckCircle className="w-6 h-6 text-emerald-600" />
              </div>
            </div>
          </div>

          {/* Rejected Card */}
          <div className="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">
                  Rejected
                </p>
                <p className="text-2xl font-bold text-red-700">
                  {stats.rejected}
                </p>
              </div>
              <div className="w-12 h-12 bg-red-50 rounded-lg flex items-center justify-center">
                <Circle className="w-6 h-6 text-red-600" />
              </div>
            </div>
          </div>
        </div>

        {/* Filters Section */}
        <div className="bg-white rounded-lg border border-gray-200 p-5 mb-6 shadow-sm">
          <div className="flex items-center gap-3 mb-4">
            <Filter className="w-5 h-5 text-gray-600" />
            <h2 className="text-base font-semibold text-gray-900">
              Filters
            </h2>
            {hasActiveFilters && (
              <button
                onClick={clearFilters}
                className="ml-auto text-sm font-medium text-[#DB0011] hover:text-[#A00010] transition-colors"
              >
                Clear All
              </button>
            )}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            
            {/* Status Filter (Maker Only) */}
            {view === 'MAKER' && (
              <SmallSelect
                label="Status"
                value={filterStatus}
                onChange={setFilterStatus}
                options={statusOptionsNoAll}
                placeholder={statusPlaceholderText}
                ariaLabel="Filter by status"
              />
            )}

            {/* Data Type Filter */}
            <SmallSelect
              label="Data Type"
              value={filterType}
              onChange={setFilterType}
              options={typeOptionsNoAll}
              placeholder={typePlaceholderText}
              ariaLabel="Filter by data type"
            />

            {/* Search Input */}
            <div className={view === 'MAKER' ? '' : 'md:col-span-2'}>
              <label className="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-2">
                Search
              </label>
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
                <input
                  type="text"
                  value={filterName}
                  onChange={(e) => setFilterName(e.target.value)}
                  placeholder="Search by name..."
                  className="w-full h-10 pl-10 pr-10 border-[1.5px] border-gray-300 rounded-md text-sm focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                  aria-label="Search by name"
                />
                {filterName && (
                  <button
                    onClick={() => setFilterName('')}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
                    aria-label="Clear search"
                  >
                    <X className="w-4 h-4" />
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Error Alert */}
        {error && (
          <div
            className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6"
            role="alert"
            aria-live="polite"
          >
            <p className="text-sm font-medium text-red-800">
              {error}
            </p>
          </div>
        )}

        {/* Loading State */}
        {loading && (
          <div
            className="bg-white rounded-lg border border-gray-200 p-12 text-center"
            role="status"
            aria-live="polite"
            aria-busy="true"
          >
            <div className="inline-block w-8 h-8 border-4 border-gray-200 border-t-[#DB0011] rounded-full animate-spin"></div>
            <p className="mt-4 text-sm text-gray-600">
              Loading queue data...
            </p>
          </div>
        )}

        {/* Data Table Section */}
        {!loading && !error && (
          <div className="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full" role="table" aria-label="Queue requests">
                
                {/* Screen Reader Caption */}
                <caption className="sr-only">
                  {view === 'MAKER' ? 'Maker queue requests' : 'Checker pending approvals'}
                </caption>
                
                {/* Table Header */}
                <thead>
                  <tr className="bg-gray-100 border-b-2 border-gray-300">
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide">
                      Data Type
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide">
                      Name
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide hidden lg:table-cell">
                      Description
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide">
                      Submitted At
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide">
                      Status
                    </th>
                    <th className="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide">
                      Action
                    </th>
                  </tr>
                </thead>
                
                {/* Table Body */}
                <tbody>
                  {pagedRows.length === 0 ? (
                    
                    /* Empty State */
                    <tr>
                      <td colSpan="6" className="px-4 py-12 text-center">
                        <div className="flex flex-col items-center justify-center">
                          <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                            <Search className="w-8 h-8 text-gray-400" />
                          </div>
                          <p className="text-sm font-medium text-gray-900 mb-1">
                            No requests found
                          </p>
                          <p className="text-sm text-gray-600">
                            {hasActiveFilters ? 'Try adjusting your filters' : 'No queue items available'}
                          </p>
                        </div>
                      </td>
                    </tr>
                  ) : (
                    
                    /* Data Rows */
                    pagedRows.map((row, index) => (
                      <tr
                        key={row.id}
                        id={`row-${index}`}
                        tabIndex={0}
                        onKeyDown={(e) => handleRowKeyDown(e, index)}
                        className="border-b border-gray-200 hover:bg-gray-50 cursor-pointer transition-colors focus:outline-none focus:bg-blue-50 focus:ring-2 focus:ring-inset focus:ring-blue-500"
                        onClick={() => handleAction(row)}
                        role="row"
                      >
                        <td className="px-4 py-4 text-sm font-medium text-gray-800">
                          {prettyType(row.type)}
                        </td>
                        <td className="px-4 py-4 text-sm text-gray-800">
                          {row.name}
                        </td>
                        <td className="px-4 py-4 text-sm text-gray-600 hidden lg:table-cell max-w-xs truncate">
                          {row.description}
                        </td>
                        <td className="px-4 py-4 text-sm text-gray-600">
                          {row.submittedAt
                            ? new Date(row.submittedAt).toLocaleString('en-US', {
                                month: '2-digit',
                                day: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                              })
                            : '-'}
                        </td>
                        <td className="px-4 py-4">
                          <StatusCell s={row.uiStatus} />
                        </td>
                        <td className="px-4 py-4 text-right">
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              handleAction(row);
                            }}
                            className="inline-flex items-center gap-1.5 px-4 py-2 bg-[#DB0011] text-white text-sm font-medium rounded-md hover:bg-[#A00010] hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all"
                            aria-label={`Open ${prettyType(row.type)} ${row.name}`}
                          >
                            Open
                            <ChevronRight className="w-4 h-4" />
                          </button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>

            {/* Pagination Section */}
            {pageCount > 1 && (
              <div className="border-t border-gray-200 px-4 py-4 bg-gray-50">
                <div className="flex items-center justify-between">
                  
                  {/* Items Count */}
                  <div className="text-sm text-gray-600">
                    Showing{' '}
                    <span className="font-medium text-gray-900">
                      {startIndex + 1}-{Math.min(startIndex + perPage, filteredRows.length)}
                    </span>{' '}
                    of{' '}
                    <span className="font-medium text-gray-900">
                      {filteredRows.length}
                    </span>{' '}
                    items
                  </div>

                  {/* Pagination Controls */}
                  <div className="flex items-center gap-2">
                    
                    {/* Previous Button */}
                    <button
                      onClick={handlePrevPage}
                      disabled={selectedPage === 0}
                      className="p-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition-all focus:outline-none focus:ring-2 focus:ring-blue-500"
                      aria-label="Previous page"
                    >
                      <ChevronLeft className="w-4 h-4" />
                    </button>

                    {/* Page Numbers */}
                    <div className="flex items-center gap-1">
                      {Array.from({ length: pageCount }, (_, i) => i).map((pageIndex) => {
                        const showPage =
                          pageIndex === 0 ||
                          pageIndex === pageCount - 1 ||
                          Math.abs(pageIndex - selectedPage) <= 1;

                        const showEllipsis =
                          (pageIndex === 1 && selectedPage > 3) ||
                          (pageIndex === pageCount - 2 && selectedPage < pageCount - 4);

                        if (showEllipsis) {
                          return (
                            <span key={pageIndex} className="px-2 text-gray-500">
                              ...
                            </span>
                          );
                        }

                        if (!showPage) return null;

                        return (
                          <button
                            key={pageIndex}
                            onClick={() => handlePageClick(pageIndex)}
                            className={`min-w-[36px] h-9 px-3 rounded-md text-sm font-medium transition-all focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                              pageIndex === selectedPage
                                ? 'bg-[#DB0011] text-white'
                                : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'
                            }`}
                            aria-label={`Go to page ${pageIndex + 1}`}
                            aria-current={pageIndex === selectedPage ? 'page' : undefined}
                          >
                            {pageIndex + 1}
                          </button>
                        );
                      })}
                    </div>

                    {/* Next Button */}
                    <button
                      onClick={handleNextPage}
                      disabled={selectedPage === pageCount - 1}
                      className="p-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition-all focus:outline-none focus:ring-2 focus:ring-blue-500"
                      aria-label="Next page"
                    >
                      <ChevronRight className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}
      </div>

      {/* Global CSS Animations */}
      <style jsx global>{`
        @keyframes slideDown {
          from {
            opacity: 0;
            transform: translateY(-8px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .animate-slideDown {
          animation: slideDown 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes spin {
          to {
            transform: rotate(360deg);
          }
        }

        .animate-spin {
          animation: spin 1s linear infinite;
        }

        .sr-only {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          margin: -1px;
          overflow: hidden;
          clip: rect(0, 0, 0, 0);
          white-space: nowrap;
          border-width: 0;
        }
      `}</style>
    </div>
  );
}
